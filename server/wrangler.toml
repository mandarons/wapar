name = "wapar-api"
main = "src/index.ts"
compatibility_date = "2024-12-01"
compatibility_flags = ["nodejs_compat"]

# D1 database configuration
[[d1_databases]]
binding = "DB"
database_name = "wapar-db"
database_id = "1522fcf7-4e32-4b84-8b13-67920f3c2a40"
# Point to Drizzle's migration folder
migrations_dir = "drizzle"

# Production environment (default) - deployed from main branch
# Note: Cron triggers removed - geo enrichment now happens just-in-time using Cloudflare's request.cf data

[vars]
# Drizzle configuration for production
DRIZZLE_LOG = "false"

# Activity threshold for active/stale installation classification
# An installation is considered "active" if it has sent a heartbeat within this threshold
# Installations without a recent heartbeat are considered "stale"
# Default: 3 days (if not specified)
# Uncomment and set to customize:
# ACTIVITY_THRESHOLD_DAYS = "7"  # Consider installations active for 7 days

[observability.logs]
enabled = true

# Local development environment
[env.dev]
port = 8787

[[env.dev.d1_databases]]
binding = "DB"
database_name = "wapar-db"
database_id = "1522fcf7-4e32-4b84-8b13-67920f3c2a40"

[env.dev.vars]
DRIZZLE_LOG = "true"

# Test routes are enabled in development for testing
# These routes (/__test/*) allow tests to interact with the database
# They are automatically disabled in production for security
# ENABLE_TEST_ROUTES is set to "1" to enable these routes in dev mode

# Staging environment - deployed from PRs
# Note: Geo enrichment now happens just-in-time using Cloudflare's request.cf data (no cron needed)
[env.staging]

[[env.staging.d1_databases]]
binding = "DB"
database_name = "wapar-db-staging"
database_id = "0f9df445-0c2e-4229-80c6-543bdb0e3770"
migrations_dir = "drizzle"

[env.staging.vars]
DRIZZLE_LOG = "true"

[env.staging.observability.logs]
enabled = true
